#Qt之d指针为什么可以解决二进制兼容
-----------------------
1.ABI是什么
&emsp;&emsp;application Binary interface面向二进制文件的接口。这里可能会联想到API，API是面向源码级别的接口。而ABI处在相对底层的位置，是面对文件的接口，因此对兼容性要求更加严格。

2.为什么会出现二进制不兼容
&emsp;&emsp;由于各种硬件平台，编程语言，编译器，链接器，操作系统的ABI相互不兼容，所以导致了各个目标文件相互无法链接。
&emsp;&emsp;首先操作系统不同，目标文件的格式就不同，比如说windows下面的PE,Linux羡慕的elf。他们之间就不可能相胡调用。
&emsp;&emsp;再者，同一个操作系统下，比如说不同的编译器，gcc和msvc，他们编译出来的文件内存格式，符号修饰标准，函数调用方式等等可能都不相同，这就导致这两个文件之间就无法相互调用。、
&emsp;&emsp;那我们同一个操作系统，同一个编译器会不会出现二进制不兼容呢，答案是会的，因为再大型程序中我们做版本升级，替换掉文件中的某些库。当我们修改了类的结构添加了某些虚函数，变量等。那么这个库的结构就发生变化，导致其他文件调用该类时就会出现错误。这个就是我们要说的二进制兼容的解决办法。

##二进制兼容
&emsp;&emsp;所谓二进制兼容对于C++ 来说就是要保证第三方使用库提供的接口对象时，保证内存布局不会改变，或者说不会影响。对于C++来说，对象内存布局的主要包括：
1.变量
2.虚函数 - 每个实例都会有一个虚函数列表（包括基类的）

###1.微软的COM模型的方案
COM涉及到几个概念：
&emsp;&emsp;class ID，可以是CLSID - class的GUID 或者 IID - interface的GUID。COM通过这个ID来保证快语言，因为基本上所有语言都可以处理GUID字符串；另外COM开发者可以通过GUID来获取到准确的对象结构。
coclass - component object class，简单来说就是COM组件提供给使用者的接口类，这些类其实都是都继承 IUnkown接口的抽象类，里面都是纯虚函数。这个IUnknown包含三个方法：
AddRef - 增加对象引用计数
Release - 减少引用计数，如果计数为0，则销毁
QueryInterface - 根据GUID来查到对象
&emsp;&emsp;COM组件还涉及到注册表，它可以注册到操作系统的注册表中，这样就算当前这个组件DLL物理位置与运行文件不在同一个目录，也可以加载并获取DLL的导出对象或者函数。更多了解可以看 

&emsp;&emsp;对于COM实现来说，因为是通过GUID来获取对象，并且这些对象都是由接口来提供的实例化（抽象类不能创建实例，这些实例都是继承的子类实现），就像 caller ----> coclass (interface) --create--> instance 这样调用。 
由于 instance 是在COM组件类（DLL）实例化以及释放，所以其内存布局对于 caller 来说是没有影响的。

###2.QT的d指针方案
&emsp;&emsp;为了不影响类得布局，可以首先给类多分配一些内存，为以后类的扩展做准备，但是这种方法的缺点是不知道类以后要扩展多少，也不灵活。而Qt的做法就很灵活了。定义一个private指针指向数据对象。如下
&emsp;&emsp;把Data类中的可能改动的类单独写一个***Private类封装起来。（其实就用到了编程思想中的把有可能变动的部分和基本不变的部分区分）这样不管再如修改DataPrivate类，都不会影响Data类的内存布局，同时也起到了隐藏核心代码的作用。可谓是精妙至极。
```
class Data；
class DataPrivate {  
public:  
    int a;
    Data *q_ptr;  
};  
  
class Data{        
private:  
    DataPrivate *d_ptr;  
};  
```
